package gui

import (
	"log"
	"os/exec"

	"fyne.io/fyne/v2"
	"fyne.io/fyne/v2/dialog"
	"github.com/KingKeule/CVE-Filter/pkg/config"
	"github.com/KingKeule/CVE-Filter/pkg/service"
)

// Create the main menu
func createMenu(actCVEFilter config.CVEFilter, window fyne.Window) *fyne.MainMenu {
	menuExportALLtoCSV := fyne.NewMenuItem("All to CSV", func() {
		if listOfCVEs == nil {
			dialog.ShowInformation("", "No CVE available to export.\nPlease download the CVE information first.", window)
			return
		}

		exportFileName := "CVE-Filter_Export_ALL.csv"
		resultExpDialog := make(chan string)
		exportDialog := createExportDialog(window, exportFileName, resultExpDialog)
		exportDialog.Show()

		go func() {
			fileURI := <-resultExpDialog
			err := service.ExportCVEListasCSV(fileURI, tableHeadlineLong, listOfCVEs)
			if err != nil {
				dialog.ShowInformation("", "A problem occured while exporting the CVE information.\n See log for more details.", window)
			}
		}()
	})

	menuExportFilteredtoCSV := fyne.NewMenuItem("Filtered to CSV", func() {
		if listOfFilteredCVEs == nil {
			dialog.ShowInformation("", "No filtered CVE available to export.\nPlease download and filter the CVE information first.", window)
			return
		}

		exportFileName := "CVE-Filter_Export_Filtered.csv"
		resultExpDialog := make(chan string)
		exportDialog := createExportDialog(window, exportFileName, resultExpDialog)
		exportDialog.Show()

		go func() {
			fileURI := <-resultExpDialog
			err := service.ExportCVEListasCSV(fileURI, tableHeadlineLong, listOfFilteredCVEs)
			if err != nil {
				dialog.ShowInformation("", "A problem occured while exporting the CVE information.\n See log for more details.", window)
			}
		}()
	})

	menuExport := fyne.NewMenuItem("Export", nil)
	menuExport.ChildMenu = fyne.NewMenu("", menuExportALLtoCSV, menuExportFilteredtoCSV)

	menuFilterSave := fyne.NewMenuItem("Save filter", func() {
		error := config.WriteCVEFilterToFile(actCVEFilter)
		if error {
			dialog.ShowInformation("", "Error while saving.\n See log for more details.", window)
		} else {
			dialog.ShowInformation("", "Configuration file \""+config.ConfigFileName+"\"\n was saved successfully", window)
		}
	})

	menuFilterAllOn := fyne.NewMenuItem("All filters on", func() {
		config.FilterAllOn(actCVEFilter)
	})

	menuFilterAllOff := fyne.NewMenuItem("All filters off", func() {
		config.FilterAllOff(actCVEFilter)
	})

	menuFilter := fyne.NewMenuItem("Filter", nil)
	menuFilter.ChildMenu = fyne.NewMenu("", menuFilterSave, menuFilterAllOn, menuFilterAllOff)

	menuHelpLog := fyne.NewMenuItem("Show Log", func() {
		showWindowsConsole(true)
	})

	menuHelpAbout := fyne.NewMenuItem("About", func() {
		// windows command to open the browser with the given link
		exec.Command("rundll32", "url.dll,FileProtocolHandler", gitHubLink).Start()
		log.Println("Open github site from the project")
	})

	menuTool := fyne.NewMenu("Tool", menuExport, menuFilter)
	menuHelp := fyne.NewMenu("Help", menuHelpLog, menuHelpAbout)

	return fyne.NewMainMenu(menuTool, menuHelp)
}
